name: VulnScout CI cqfd + kas with comparing CVEs

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  vulnscout-ci:
    runs-on: [self-hosted, linux]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Enable user namespaces
        run: |
          sudo sysctl -w kernel.apparmor_restrict_unprivileged_userns=0

      - name: Install cqfd on the CI
        if: matrix.target != 'Docker'
        run: |
          git clone https://github.com/savoirfairelinux/cqfd.git
          cd cqfd
          sudo make install

      - name: Init cqfd container on the project
        if: matrix.target != 'Docker'
        run: cqfd init

      - name: Get commit info
        id: commit_info
        run: |
          echo "current_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "before_sha=${{ github.event.before }}" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT

      - name: Download previous CVE report
        id: download_previous
        uses: dawidd6/action-download-artifact@v3
        with:
          name: cve_report_${{ steps.commit_info.outputs.before_sha }}
          path: previous_cve_report
          workflow: vulnscout_ci.yml
          if_no_artifact_found: ignore

      - name: Check download status
        run: |
          if [ ! -f previous_cve_report/cve_report.txt ]; then
            echo "No previous CVE report found for commit ${{ steps.commit_info.outputs.before_sha }}."
            echo "This might be the first run, artifacts expired, or comparing across different commits."
          else
            echo "Previous CVE report found for commit ${{ steps.commit_info.outputs.before_sha }}."
          fi

      - name: Run vulnscout_ci and capture CVEs
        id: run_cqfd
        run: |
          set +e
          cqfd -b vulnscout_ci 2>&1 | tee cqfd_output.txt
          echo ${PIPESTATUS[0]} > cqfd_exit_code.txt
          grep -Eoi 'CVE-[0-9]{4}-[0-9]+' cqfd_output.txt | sort | uniq > cve_report.txt

      - name: Upload CVE report artifact
        uses: actions/upload-artifact@v4
        with:
          name: cve_report_${{ steps.commit_info.outputs.date }}_${{ github.sha }}
          path: cve_report.txt
          retention-days: 90

      - name: Cleanup workspace permissions
        if: always()
        run: sudo chown -R $USER .

      - name: Compare CVE reports
        run: |
          if [ -f cve_report.txt ] && [ -f previous_cve_report/cve_report.txt ]; then
            echo "ðŸ“Š Comparing CVE reports between commits..."
            echo "Previous commit: ${{ steps.commit_info.outputs.before_sha }}"
            echo "Current commit: ${{ steps.commit_info.outputs.current_sha }}"
            echo ""

            comm -13 <(sort previous_cve_report/cve_report.txt) <(sort cve_report.txt) > new_cves.txt
            comm -23 <(sort previous_cve_report/cve_report.txt) <(sort cve_report.txt) > fixed_cves.txt

            # Count the changes
            new_count=$(wc -l < new_cves.txt || echo 0)
            fixed_count=$(wc -l < fixed_cves.txt || echo 0)

            echo "Summary:"
            echo "- New CVEs: $new_count"
            echo "- Fixed CVEs: $fixed_count"
            echo ""

            if [ -s fixed_cves.txt ]; then
              echo "âœ… Fixed CVEs:"
              cat fixed_cves.txt
              echo ""
            fi

            if [ -s new_cves.txt ]; then
              echo "âŒ New CVEs detected:"
              cat new_cves.txt
              echo ""
              echo "::error::Build introduced $new_count new CVE(s). Please review and address these vulnerabilities."
              exit 1
            else
              if [ $fixed_count -gt 0 ]; then
                echo "âœ… Great! Fixed $fixed_count CVE(s) and no new CVEs introduced."
              else
                echo "âœ… No new CVEs detected."
              fi
            fi
          else
            echo "âš ï¸  No previous CVE report to compare."
            if [ -f cve_report.txt ]; then
              cve_count=$(wc -l < cve_report.txt || echo 0)
              echo "Current build has $cve_count CVE(s) - establishing baseline."
            fi
            echo "Skipping comparison."
          fi